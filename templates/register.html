<!doctype html>
<!-- Version: 2.2 - Registration with ID Proof and Selfie Proof -->
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate, max-age=0">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  <title>Online Canteen ‚Äî Register</title>
  <link rel="stylesheet" href="/static/style.css">
  <link rel="stylesheet" href="/static/auth.css">
</head>
<body>
  <div class="auth-wrap">
    <div class="auth-card card">
      <div class="app-logo">
        <div class="app-logo-circle">
          <span class="app-logo-plate">üçΩÔ∏è</span>
        </div>
        <div class="app-logo-text">
          <span class="app-logo-title">Online Canteen</span>
          <span class="app-logo-subtitle">Create your account</span>
        </div>
      </div>

      <h2 class="headline center">Create your account</h2>

      <label class="input-label">Full name</label>
      <input id="regName" type="text" placeholder="Enter your full name">

      <label class="input-label">Email</label>
      <input id="regEmail" type="email" placeholder="you@example.com">

      <label class="input-label">Password</label>
      <div class="password-row">
        <input id="regPass" type="password" placeholder="Enter your password (min 4 chars)">
        <button type="button" class="password-toggle" onclick="togglePasswordVisibility('regPass', 'regPassToggle')" id="regPassToggle" title="Show password">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
            <circle cx="12" cy="12" r="3"></circle>
          </svg>
        </button>
      </div>

      <label class="input-label">Confirm Password</label>
      <div class="password-row">
        <input id="regConfirmPass" type="password" placeholder="Re-enter your password">
        <button type="button" class="password-toggle" onclick="togglePasswordVisibility('regConfirmPass', 'regConfirmPassToggle')" id="regConfirmPassToggle" title="Show password">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
            <circle cx="12" cy="12" r="3"></circle>
          </svg>
        </button>
      </div>

      <label class="input-label">üì∑ ID Proof (Required)</label>
      <input type="file" id="regIdProof" accept="image/*" capture="environment" style="display: none;">
      <div style="display: flex; gap: 8px; margin-bottom: 8px;">
        <button type="button" class="btn" onclick="document.getElementById('regIdProof').click()" style="flex: 1; padding: 10px;">
          üì∑ Upload ID Proof
        </button>
        <button type="button" class="btn" onclick="document.getElementById('regIdProof').click()" style="flex: 1; padding: 10px;">
          üì∏ Take Photo
        </button>
      </div>
      <div id="idProofPreview" style="display: none; margin-top: 8px;">
        <img id="idProofImage" src="" alt="ID Proof Preview" style="max-width: 100%; max-height: 200px; border-radius: 8px; border: 2px solid #8B4513;">
        <button type="button" class="btn ghost" onclick="clearIdProof()" style="margin-top: 8px; width: 100%;">Remove ID Proof</button>
      </div>
      <p style="font-size: 0.85rem; color: #666; margin-top: 4px;">
        üí° Upload a clear photo of your valid ID (Student ID, Driver's License, etc.)
      </p>

      <label class="input-label" style="margin-top: 16px;">ü§≥ Selfie Proof (Required)</label>
      <input type="file" id="regSelfieProof" accept="image/*" capture="user" style="display: none;">
      <div style="display: flex; gap: 8px; margin-bottom: 8px;">
        <button type="button" class="btn" onclick="document.getElementById('regSelfieProof').click()" style="flex: 1; padding: 10px;">
          üì∑ Upload Selfie
        </button>
        <button type="button" class="btn" onclick="document.getElementById('regSelfieProof').click()" style="flex: 1; padding: 10px;">
          üì∏ Take Selfie
        </button>
      </div>
      <div id="selfieProofPreview" style="display: none; margin-top: 8px;">
        <img id="selfieProofImage" src="" alt="Selfie Proof Preview" style="max-width: 100%; max-height: 200px; border-radius: 8px; border: 2px solid #2196F3;">
        <button type="button" class="btn ghost" onclick="clearSelfieProof()" style="margin-top: 8px; width: 100%;">Remove Selfie</button>
      </div>
      <p style="font-size: 0.85rem; color: #666; margin-top: 4px;">
        üí° Take a selfie holding your ID next to your face for verification
      </p>

      <!-- Consent Checkboxes -->
      <div class="consent-section">
        <label class="consent-checkbox">
          <input type="checkbox" id="consentPromotions" required>
          <span class="checkmark"></span>
          <span class="consent-text">I would like to receive announcements and promotions from Canteen.</span>
        </label>

        <label class="consent-checkbox">
          <input type="checkbox" id="consentPrivacy" required>
          <span class="checkmark"></span>
          <span class="consent-text">I consent to the use and processing of my personal information for Customer Relationship Management purposes. I am aware of my data privacy rights including the option to withdraw my consent at any time.</span>
        </label>

        <label class="consent-checkbox">
          <input type="checkbox" id="consentTerms" required>
          <span class="checkmark"></span>
          <span class="consent-text">I have fully read, understood, and agree to the <a href="#" onclick="showTermsModal(); return false;" class="consent-link">Data Privacy Policy</a> and <a href="#" onclick="showTermsModal(); return false;" class="consent-link">Terms & Conditions</a> of Online Canteen.</span>
        </label>
      </div>

      <button class="btn btn-primary-large mt-8" onclick="registerUser()">Create your Account</button>
      <p class="center mt-4 muted" style="font-size: 0.85rem;" id="regMessage">
        ‚è≥ Your account will be reviewed by admin before you can login.
      </p>

      <p class="center mt-8 muted">
        Already registered? <a href="index.html" class="link">Login</a>
      </p>
    </div>
  </div>

  <!-- Terms Modal -->
  <div id="termsModal" class="modal" style="display: none;">
    <div class="modal-content">
      <span class="close-modal" onclick="closeTermsModal()">&times;</span>
      <h3>Terms & Conditions / Data Privacy Policy</h3>
      <div class="modal-body">
        <p><strong>Data Privacy Policy:</strong></p>
        <p>Online Canteen respects your privacy. We collect and process your personal information solely for the purpose of managing your account, processing orders, and providing customer service. Your data will not be shared with third parties without your consent.</p>
        <p>You have the right to access, correct, or delete your personal information at any time. You may withdraw your consent by contacting us.</p>
        <p><strong>Terms & Conditions:</strong></p>
        <p><strong>1. Account Registration:</strong> By creating an account, you agree to provide accurate and complete information. You are responsible for maintaining the confidentiality of your account credentials.</p>
        
        <p><strong>2. Order Placement:</strong> All orders are subject to product availability. Prices are subject to change without prior notice. We reserve the right to refuse or cancel any order at our discretion.</p>
        
        <p><strong>3. Payment Terms:</strong> Payment must be completed before order processing. We accept GCash payments only. Payment proof must be submitted for verification. Orders will not be processed until payment is confirmed.</p>
        
        <p><strong>4. Delivery Terms:</strong></p>
        <ul style="margin-left: 20px; margin-top: 5px; margin-bottom: 10px;">
          <li>Delivery times are estimates and may vary based on location and order volume.</li>
          <li>You must be available at the delivery address during the scheduled delivery time.</li>
          <li>You must provide accurate delivery address and contact information. Incorrect information may result in delivery delays or additional charges.</li>
          <li>If you are not available at the delivery address, the order may be left at a designated safe location or returned to the canteen, subject to additional fees.</li>
          <li><strong style="color: #d32f2f;">MANDATORY DELIVERY PROOF:</strong> Upon delivery, our delivery rider is <strong>required</strong> to take a clear photograph of you (the buyer) with the delivered food items as proof of successful delivery. This photo will be automatically uploaded to our system and serves as confirmation that the order was received. By accepting delivery, you consent to having your photo taken for delivery verification purposes.</li>
          <li>The delivery photo must clearly show both the customer (buyer) and the food items received in the same frame.</li>
          <li>You are required to cooperate with the delivery rider for the delivery photo. Refusal to allow the photo may result in the order being marked as undelivered.</li>
          <li>We reserve the right to verify delivery completion through the delivery photo before marking orders as delivered.</li>
          <li>Delivery photos are stored securely and used solely for order verification and dispute resolution purposes.</li>
        </ul>
        
        <p><strong>5. Refund and Cancellation Policy:</strong> Cancellations must be made before order preparation begins. Refunds are processed according to our refund policy. No refunds will be issued for orders that have been delivered and confirmed with delivery photo. Partial refunds may be issued for incorrect or damaged items if reported within 2 hours of delivery with photographic evidence.</p>
        
        <p><strong>6. Food Quality and Safety:</strong> We strive to maintain the highest quality standards. If you receive damaged, incorrect, or unsatisfactory items, please contact us immediately through the platform's messaging system with photographic evidence. We will investigate and provide appropriate resolution within 24-48 hours. Quality complaints must be reported within 2 hours of delivery to be eligible for resolution.</p>
        
        <p><strong>7. Delivery Rider Responsibilities:</strong> Our delivery riders are trained to handle orders with care and professionalism. They are required to:</p>
        <ul style="margin-left: 20px; margin-top: 5px; margin-bottom: 10px;">
          <li>Maintain food safety standards during transport</li>
          <li>Deliver orders within the estimated time frame</li>
          <li>Take mandatory delivery photos as proof of delivery</li>
          <li>Handle orders and customer interactions professionally</li>
          <li>Report any delivery issues or concerns immediately</li>
        </ul>
        
        <p><strong>8. User Conduct:</strong> You agree to use the service responsibly and in accordance with our policies. Prohibited activities include: fraudulent orders, abuse of the refund system, harassment of staff or delivery riders, refusal to cooperate with delivery procedures (including delivery photos), or any illegal activities. We reserve the right to suspend or terminate accounts that violate these terms.</p>
        
        <p><strong>9. Privacy and Photo Usage:</strong> Delivery photos are collected for order verification purposes only. Your image will not be used for marketing or promotional purposes without your explicit consent. Photos are stored securely and retained only as long as necessary for order verification and dispute resolution. You have the right to request deletion of your delivery photos after order completion, subject to legal and operational requirements.</p>
        
        <p><strong>10. Dispute Resolution:</strong> In case of disputes regarding delivery, order accuracy, or payment, delivery photos serve as primary evidence. We will review all available evidence including delivery photos, order details, and communication records to resolve disputes fairly. Our decision on disputes is final, but you may contact customer support for further assistance.</p>
        
        <p><strong>11. Limitation of Liability:</strong> Online Canteen shall not be liable for any indirect, incidental, or consequential damages arising from the use of our service. Our total liability shall not exceed the value of the order in question. We are not responsible for delays caused by factors beyond our control, including but not limited to weather conditions, traffic, or customer unavailability.</p>
        
        <p><strong>12. Modifications to Terms:</strong> We reserve the right to modify these terms and conditions at any time. Continued use of the service after changes constitutes acceptance of the modified terms. Significant changes will be communicated through the platform or via email.</p>
        
        <p><strong>13. Contact and Support:</strong> For questions, concerns, delivery issues, or quality complaints, please contact us immediately through the platform's messaging system or customer support channels. Response time is typically within 24 hours during business days.</p>
        
        <p style="margin-top: 15px; padding: 10px; background: #fff3cd; border-left: 4px solid #ffc107; border-radius: 4px;">
          <strong>‚ö†Ô∏è Important:</strong> By using Online Canteen services, you acknowledge that you have read, understood, and agree to be bound by all terms and conditions stated above, including the mandatory delivery photo requirement.
        </p>
      </div>
    </div>
  </div>

  <script src="/static/script.js"></script>
  <script>
    function togglePasswordVisibility(inputId, buttonId){
      const input = document.getElementById(inputId);
      const button = document.getElementById(buttonId);
      if(input && button) {
        const svg = button.querySelector('svg');
        if(input.type === 'password') {
          input.type = 'text';
          button.title = 'Hide password';
          // Change to eye-slash icon
          if(svg) {
            svg.innerHTML = '<path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"></path><line x1="1" y1="1" x2="23" y2="23"></line>';
          }
        } else {
          input.type = 'password';
          button.title = 'Show password';
          // Change back to eye icon
          if(svg) {
            svg.innerHTML = '<path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle>';
          }
        }
      }
    }

    function showTermsModal() {
      const modal = document.getElementById('termsModal');
      if(modal) {
        modal.style.display = 'block';
      }
    }

    function closeTermsModal() {
      const modal = document.getElementById('termsModal');
      if(modal) {
        modal.style.display = 'none';
      }
    }

    // Close modal when clicking outside
    window.onclick = function(event) {
      const modal = document.getElementById('termsModal');
      if (event.target == modal) {
        closeTermsModal();
      }
    }

    // Check if this is first user on page load
    window.addEventListener('DOMContentLoaded', async function() {
      try {
        const checkResponse = await fetch('/users');
        const existingUsers = await checkResponse.json();
        if (existingUsers.length === 0) {
          const msgEl = document.getElementById('regMessage');
          if (msgEl) {
            msgEl.innerHTML = 'üëë You will be the first admin! No approval needed.';
            msgEl.style.color = '#4caf50';
          }
          // Make ID proof and selfie optional for first admin - update label text
          const idProofLabel = document.querySelector('label[for="regIdProof"], .input-label');
          const selfieProofLabel = document.querySelectorAll('.input-label');
          selfieProofLabel.forEach(label => {
            if (label.textContent.includes('ID Proof')) {
              label.innerHTML = 'üì∑ ID Proof (Optional for first admin)';
            }
            if (label.textContent.includes('Selfie Proof')) {
              label.innerHTML = 'ü§≥ Selfie Proof (Optional for first admin)';
            }
          });
        }
      } catch(e) {
        console.log('Could not check existing users:', e);
      }
    });

    // Store base64 images
    let idProofBase64 = null;
    let selfieProofBase64 = null;

    // Handle ID Proof file selection
    document.getElementById('regIdProof').addEventListener('change', function(e) {
      const file = e.target.files[0];
      if (!file) return;

      // Validate file type
      if (!file.type.startsWith('image/')) {
        alert('Please select an image file');
        return;
      }

      // Validate file size (max 5MB)
      if (file.size > 5 * 1024 * 1024) {
        alert('Image size must be less than 5MB');
        return;
      }

      const reader = new FileReader();
      reader.onload = function(e) {
        idProofBase64 = e.target.result;
        const preview = document.getElementById('idProofPreview');
        const image = document.getElementById('idProofImage');
        if (preview && image) {
          image.src = idProofBase64;
          preview.style.display = 'block';
        }
      };
      reader.readAsDataURL(file);
    });

    // Handle Selfie Proof file selection
    document.getElementById('regSelfieProof').addEventListener('change', function(e) {
      const file = e.target.files[0];
      if (!file) return;

      // Validate file type
      if (!file.type.startsWith('image/')) {
        alert('Please select an image file');
        return;
      }

      // Validate file size (max 5MB)
      if (file.size > 5 * 1024 * 1024) {
        alert('Image size must be less than 5MB');
        return;
      }

      const reader = new FileReader();
      reader.onload = function(e) {
        selfieProofBase64 = e.target.result;
        const preview = document.getElementById('selfieProofPreview');
        const image = document.getElementById('selfieProofImage');
        if (preview && image) {
          image.src = selfieProofBase64;
          preview.style.display = 'block';
        }
      };
      reader.readAsDataURL(file);
    });

    // Clear ID Proof
    function clearIdProof() {
      idProofBase64 = null;
      document.getElementById('regIdProof').value = '';
      document.getElementById('idProofPreview').style.display = 'none';
      document.getElementById('idProofImage').src = '';
    }

    // Clear Selfie Proof
    function clearSelfieProof() {
      selfieProofBase64 = null;
      document.getElementById('regSelfieProof').value = '';
      document.getElementById('selfieProofPreview').style.display = 'none';
      document.getElementById('selfieProofImage').src = '';
    }

    // Make functions global
    window.clearIdProof = clearIdProof;
    window.clearSelfieProof = clearSelfieProof;

    // Override registerUser
    const originalRegisterUser = window.registerUser;
    window.registerUser = async function() {
      const name = (document.getElementById('regName')?.value || '').trim();
      const email = (document.getElementById('regEmail')?.value || '').trim().toLowerCase();
      const pass = (document.getElementById('regPass')?.value || '').trim();
      const confirmPass = (document.getElementById('regConfirmPass')?.value || '').trim();

      if(!name || !email || !pass) {
        return alert('Please fill all fields.');
      }

      if(pass.length < 4) {
        return alert('Password must be at least 4 characters.');
      }

      if(pass !== confirmPass) {
        return alert('‚ùå Passwords do not match! Please try again.');
      }

      // Check if this is first user (becomes admin - proofs optional)
      let isFirstUser = false;
      try {
        const checkResponse = await fetch('/users');
        const existingUsers = await checkResponse.json();
        if (existingUsers.length === 0) {
          isFirstUser = true;
        }
      } catch(e) {
        console.log('Could not check existing users:', e);
      }

      // Validate proof requirements (not required for first user/admin)
      if (!isFirstUser) {
        if (!idProofBase64) {
          return alert('Please upload your ID Proof.');
        }
        if (!selfieProofBase64) {
          return alert('Please upload your Selfie Proof.');
        }
      }

      // Check consent checkboxes
      const consentPromotions = document.getElementById('consentPromotions');
      const consentPrivacy = document.getElementById('consentPrivacy');
      const consentTerms = document.getElementById('consentTerms');

      if (!consentPromotions.checked || !consentPrivacy.checked || !consentTerms.checked) {
        return alert('Please accept all terms and conditions to continue.');
      }

      try {
        const response = await fetch('/register', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ 
            name, 
            email, 
            password: pass,
            id_proof: idProofBase64 || null,
            selfie_proof: selfieProofBase64 || null
          })
        });

        const data = await response.json();
        
        if(response.ok) {
          // Check if this was the first user (admin)
          if (isFirstUser) {
            alert('‚úÖ Admin account created successfully! You can now login.');
          } else {
            alert('‚úÖ Registration successful! Your account is pending admin approval. You will be notified once approved.');
          }
          location.href = 'index.html';
        } else {
          alert(data.detail || 'Registration failed');
        }
      } catch(error) {
        console.error('Registration error:', error);
        alert('Registration failed. Please try again.');
      }
    };
  </script>
</body>
</html>
